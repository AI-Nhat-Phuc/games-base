name: Publish Packages to NPM

on:
  push:
    branches:
      - main
    paths:
      - 'cli/**'
      - 'base/**'
      - 'server/**'
      - 'builders/**'
      - 'package.json'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'cli/**'
      - 'base/**'
      - 'server/**'
      - 'builders/**'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        default: 'all'
        type: choice
        options:
          - cli
          - client
          - server
          - builder
          - all
      force_publish:
        description: 'Force publish even if no changes'
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cli_changed: ${{ steps.changes.outputs.cli }}
      client_changed: ${{ steps.changes.outputs.client }}
      server_changed: ${{ steps.changes.outputs.server }}
      builder_changed: ${{ steps.changes.outputs.builder }}
      pr_number: ${{ steps.pr.outputs.pr_number }}
      is_main: ${{ steps.branch.outputs.is_main }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch
        id: branch
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event.inputs.force_publish }}" == "true" ] || [ "${{ github.event.inputs.package }}" != "" ]; then
            # Manual workflow dispatch or force publish
            echo "cli=true" >> $GITHUB_OUTPUT
            echo "client=true" >> $GITHUB_OUTPUT
            echo "server=true" >> $GITHUB_OUTPUT
            echo "builder=true" >> $GITHUB_OUTPUT
          else
            # Check for actual file changes
            if git diff --name-only HEAD^ HEAD | grep -q '^cli/'; then
              echo "cli=true" >> $GITHUB_OUTPUT
            else
              echo "cli=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only HEAD^ HEAD | grep -q '^base/'; then
              echo "client=true" >> $GITHUB_OUTPUT
            else
              echo "client=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only HEAD^ HEAD | grep -q '^server/'; then
              echo "server=true" >> $GITHUB_OUTPUT
            else
              echo "server=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only HEAD^ HEAD | grep -q '^builders/'; then
              echo "builder=true" >> $GITHUB_OUTPUT
            else
              echo "builder=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish-cli:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      (needs.detect-changes.outputs.cli_changed == 'true' && 
       (github.event_name == 'push' || github.event_name == 'pull_request')) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package == 'cli' || github.event.inputs.package == 'all'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: |
          cd cli
          npm install
          
      - name: Build package
        run: |
          cd cli
          npm run build
          
      - name: Configure NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
      - name: Set version
        id: version
        run: |
          cd cli
          if [ "${{ needs.detect-changes.outputs.is_main }}" == "true" ]; then
            # Main branch - publish as latest
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing version: $VERSION with tag: latest"
          else
            # PR branch - publish as beta
            BASE_VERSION=$(node -p "require('./package.json').version")
            PR_NUMBER="${{ needs.detect-changes.outputs.pr_number }}"
            BETA_VERSION="${BASE_VERSION}-beta-pr-${PR_NUMBER}.$(date +%Y%m%d%H%M%S)"
            npm version $BETA_VERSION --no-git-tag-version
            echo "version=$BETA_VERSION" >> $GITHUB_OUTPUT
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Publishing version: $BETA_VERSION with tag: beta"
          fi
          
      - name: Publish to NPM
        run: |
          cd cli
          npm publish --access public --tag ${{ steps.version.outputs.tag }}
          
      - name: Create summary
        run: |
          echo "## ✅ Published @pnp/cli" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.tag }}" == "latest" ]; then
            echo "npx @pnp/cli create my-game" >> $GITHUB_STEP_SUMMARY
          else
            echo "npx @pnp/cli@${{ steps.version.outputs.version }} create my-game" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  publish-client:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      (needs.detect-changes.outputs.client_changed == 'true' && 
       (github.event_name == 'push' || github.event_name == 'pull_request')) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package == 'client' || github.event.inputs.package == 'all'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: |
          cd base
          npm install
          
      - name: Build package
        run: |
          cd base
          npm run build
          
      - name: Configure NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
      - name: Set version
        id: version
        run: |
          cd base
          if [ "${{ needs.detect-changes.outputs.is_main }}" == "true" ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing version: $VERSION with tag: latest"
          else
            BASE_VERSION=$(node -p "require('./package.json').version")
            PR_NUMBER="${{ needs.detect-changes.outputs.pr_number }}"
            BETA_VERSION="${BASE_VERSION}-beta-pr-${PR_NUMBER}.$(date +%Y%m%d%H%M%S)"
            npm version $BETA_VERSION --no-git-tag-version
            echo "version=$BETA_VERSION" >> $GITHUB_OUTPUT
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Publishing version: $BETA_VERSION with tag: beta"
          fi
          
      - name: Publish to NPM
        run: |
          cd base
          npm publish --access public --tag ${{ steps.version.outputs.tag }}
          
      - name: Create summary
        run: |
          echo "## ✅ Published @pnp/game-core-client" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.tag }}" == "latest" ]; then
            echo "npm install @pnp/game-core-client" >> $GITHUB_STEP_SUMMARY
          else
            echo "npm install @pnp/game-core-client@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  publish-server:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      (needs.detect-changes.outputs.server_changed == 'true' && 
       (github.event_name == 'push' || github.event_name == 'pull_request')) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package == 'server' || github.event.inputs.package == 'all'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: |
          cd server
          npm install
          
      - name: Build package
        run: |
          cd server
          npm run build
          
      - name: Configure NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
      - name: Set version
        id: version
        run: |
          cd server
          if [ "${{ needs.detect-changes.outputs.is_main }}" == "true" ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing version: $VERSION with tag: latest"
          else
            BASE_VERSION=$(node -p "require('./package.json').version")
            PR_NUMBER="${{ needs.detect-changes.outputs.pr_number }}"
            BETA_VERSION="${BASE_VERSION}-beta-pr-${PR_NUMBER}.$(date +%Y%m%d%H%M%S)"
            npm version $BETA_VERSION --no-git-tag-version
            echo "version=$BETA_VERSION" >> $GITHUB_OUTPUT
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Publishing version: $BETA_VERSION with tag: beta"
          fi
          
      - name: Publish to NPM
        run: |
          cd server
          npm publish --access public --tag ${{ steps.version.outputs.tag }}
          
      - name: Create summary
        run: |
          echo "## ✅ Published @pnp/game-core-server" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.tag }}" == "latest" ]; then
            echo "npm install @pnp/game-core-server" >> $GITHUB_STEP_SUMMARY
          else
            echo "npm install @pnp/game-core-server@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  publish-builder:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      (needs.detect-changes.outputs.builder_changed == 'true' && 
       (github.event_name == 'push' || github.event_name == 'pull_request')) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package == 'builder' || github.event.inputs.package == 'all'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: |
          cd builders
          npm install
          
      - name: Build package
        run: |
          cd builders
          npm run build
          
      - name: Configure NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
      - name: Set version
        id: version
        run: |
          cd builders
          if [ "${{ needs.detect-changes.outputs.is_main }}" == "true" ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing version: $VERSION with tag: latest"
          else
            BASE_VERSION=$(node -p "require('./package.json').version")
            PR_NUMBER="${{ needs.detect-changes.outputs.pr_number }}"
            BETA_VERSION="${BASE_VERSION}-beta-pr-${PR_NUMBER}.$(date +%Y%m%d%H%M%S)"
            npm version $BETA_VERSION --no-git-tag-version
            echo "version=$BETA_VERSION" >> $GITHUB_OUTPUT
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Publishing version: $BETA_VERSION with tag: beta"
          fi
          
      - name: Publish to NPM
        run: |
          cd builders
          npm publish --access public --tag ${{ steps.version.outputs.tag }}
          
      - name: Create summary
        run: |
          echo "## ✅ Published @pnp/builder" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.tag }}" == "latest" ]; then
            echo "npm install @pnp/builder" >> $GITHUB_STEP_SUMMARY
          else
            echo "npm install @pnp/builder@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Run tests after publishing
  test-published-cli:
    needs: [publish-cli]
    if: needs.publish-cli.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install CLI dependencies
        run: |
          cd cli
          npm install
          
      - name: Build CLI
        run: |
          cd cli
          npm run build
          
      - name: Test CLI commands
        run: |
          cd cli
          node bin/pnp.js --version
          node bin/pnp.js --help
          
      - name: Test CLI create command
        run: |
          cd cli
          node bin/pnp.js create test-game --skip-install
          test -d test-game
          test -f test-game/package.json
  
  test-published-packages:
    needs: [publish-client, publish-server, publish-builder]
    if: always()
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: 
          - { name: 'client', dir: 'base', needs: 'publish-client' }
          - { name: 'server', dir: 'server', needs: 'publish-server' }
          - { name: 'builder', dir: 'builders', needs: 'publish-builder' }
    steps:
      - name: Check if package was published
        id: check
        run: |
          if [ "${{ needs[matrix.package.needs].result }}" == "success" ]; then
            echo "published=true" >> $GITHUB_OUTPUT
          else
            echo "published=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout repository
        if: steps.check.outputs.published == 'true'
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        if: steps.check.outputs.published == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        if: steps.check.outputs.published == 'true'
        run: |
          cd ${{ matrix.package.dir }}
          npm install
          
      - name: Build package
        if: steps.check.outputs.published == 'true'
        run: |
          cd ${{ matrix.package.dir }}
          npm run build
          
      - name: Run security audit
        if: steps.check.outputs.published == 'true'
        run: |
          cd ${{ matrix.package.dir }}
          npm audit --audit-level=moderate || true
          
      - name: Create test summary
        if: steps.check.outputs.published == 'true'
        run: |
          echo "## ✅ Tests passed for ${{ matrix.package.name }}" >> $GITHUB_STEP_SUMMARY
