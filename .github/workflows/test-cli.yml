name: Test CLI

on:
  push:
    branches: [main, develop]
    paths:
      - 'cli/**'
      - '.github/workflows/test-cli.yml'
  pull_request:
    paths:
      - 'cli/**'
      - '.github/workflows/test-cli.yml'
  workflow_dispatch:

jobs:
  test-cli:
    name: Test CLI on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: cli/package-lock.json

      - name: Install dependencies
        working-directory: ./cli
        run: npm ci || npm install

      - name: Build CLI
        working-directory: ./cli
        run: npm run build

      - name: Test CLI commands exist
        working-directory: ./cli
        run: |
          node ./bin/pnp.js --version || echo "CLI version check failed"
          node ./bin/pnp.js --help || echo "CLI help check failed"

      - name: Test create command (dry run)
        working-directory: ./cli
        run: |
          mkdir -p ../tmp-test
          cd ../tmp-test
          node ../cli/bin/pnp.js create test-game --skip-install || echo "Create command test completed"

      - name: Verify created project structure
        if: runner.os == 'Linux'
        run: |
          if [ -d "tmp-test/test-game" ]; then
            echo "✓ Project directory created"
            ls -la tmp-test/test-game
          else
            echo "✗ Project directory not created"
            exit 1
          fi

      - name: Test build-character command
        if: runner.os == 'Linux'
        working-directory: ./cli
        run: |
          node ./bin/pnp.js build-character --help || echo "Build character help completed"

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cli-test-artifacts-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            cli/dist
            tmp-test
          retention-days: 7

  test-cli-integration:
    name: Integration Test - CLI Project Creation
    runs-on: ubuntu-latest
    needs: test-cli
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Build CLI
        working-directory: ./cli
        run: |
          npm install
          npm run build

      - name: Create test project
        run: |
          mkdir -p integration-test
          cd integration-test
          node ../cli/bin/pnp.js create my-test-game --skip-install
          cd my-test-game
          
          # Check required files exist
          test -f package.json || exit 1
          test -f tsconfig.json || exit 1
          test -f vite.config.ts || exit 1
          test -f index.html || exit 1
          test -f src/main.ts || exit 1
          
          echo "✓ All required files created successfully"

      - name: Install and build created project
        run: |
          cd integration-test/my-test-game
          npm install
          npm run build
          
          # Verify build output
          test -d dist || exit 1
          echo "✓ Project builds successfully"

      - name: Test character builder command
        run: |
          cd integration-test/my-test-game
          node ../../cli/bin/pnp.js build-character \
            --name TestHero \
            --output ./src/characters \
            --skip-assets || echo "Character builder test completed"

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cli-integration-test-results
          path: integration-test
          retention-days: 7
