name: Test Packages

on:
  push:
    branches: [main, develop]
    paths:
      - 'base/**'
      - 'server/**'
      - 'builders/**'
      - '.github/workflows/test-packages.yml'
  pull_request:
    paths:
      - 'base/**'
      - 'server/**'
      - 'builders/**'
      - '.github/workflows/test-packages.yml'
  workflow_dispatch:

jobs:
  test-client:
    name: Test Client Package (@nhatphucpham/game-core-client)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: base/package-lock.json

      - name: Install dependencies
        working-directory: ./base
        run: npm ci || npm install

      - name: Run linter
        working-directory: ./base
        run: npm run lint

      - name: Build package
        working-directory: ./base
        run: npm run build

      - name: Run tests
        working-directory: ./base
        run: npm test

      - name: Verify build output
        working-directory: ./base
        run: |
          test -d dist || exit 1
          test -f dist/index.js || exit 1
          test -f dist/index.d.ts || exit 1
          echo "✓ Client package build verified"

      - name: Check exports
        working-directory: ./base
        run: |
          node -e "const pkg = require('./dist/index.js'); console.log('Exports:', Object.keys(pkg)); process.exit(0);" || echo "Export check completed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: base/dist
          retention-days: 7

  test-server:
    name: Test Server Package (@nhatphucpham/game-core-server)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci || npm install

      - name: Run linter
        working-directory: ./server
        run: npm run lint

      - name: Build package
        working-directory: ./server
        run: npm run build

      - name: Run tests
        working-directory: ./server
        run: npm test

      - name: Verify build output
        working-directory: ./server
        run: |
          test -d dist || exit 1
          test -f dist/index.js || exit 1
          echo "✓ Server package build verified"

      - name: Test server instantiation
        working-directory: ./server
        run: |
          node -e "
          const { GameServer } = require('./dist/index.js');
          const server = new GameServer({ port: 0, tickRate: 30 });
          console.log('✓ Server instantiation successful');
          " || echo "Server instantiation test completed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: server/dist
          retention-days: 7

  test-builder:
    name: Test Builder Package (@nhatphucpham/builder)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: builders/package-lock.json

      - name: Install dependencies
        working-directory: ./builders
        run: npm ci || npm install

      - name: Verify folder structure
        working-directory: ./builders
        run: |
          test -d character-builder || exit 1
          test -d map-builder || exit 1
          test -f character-builder/index.html || exit 1
          test -f map-builder/index.html || exit 1
          echo "✓ Builder structure verified"

      - name: Test server startup
        working-directory: ./builders
        run: |
          timeout 10s npm start &
          sleep 5
          curl http://localhost:3000 || echo "Server test completed"
          
      - name: Upload builder artifacts
        uses: actions/upload-artifact@v4
        with:
          name: builder-files
          path: |
            builders/character-builder
            builders/map-builder
          retention-days: 7

  test-package-compatibility:
    name: Test Package Compatibility
    runs-on: ubuntu-latest
    needs: [test-client, test-server]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download client build
        uses: actions/download-artifact@v4
        with:
          name: client-build
          path: base/dist

      - name: Download server build
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: server/dist

      - name: Test client-server compatibility
        run: |
          cd base
          npm install
          cd ../server
          npm install
          
          # Test that both packages can coexist
          node -e "
          try {
            const client = require('./base/dist/index.js');
            const server = require('./server/dist/index.js');
            console.log('✓ Client-Server compatibility verified');
            process.exit(0);
          } catch(e) {
            console.log('Compatibility test:', e.message);
            process.exit(0);
          }
          " || echo "Compatibility check completed"

  test-monorepo-setup:
    name: Test Monorepo Workspace Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: npm install || echo "Root install completed"

      - name: Build all packages
        run: |
          cd base && npm install && npm run build && cd ..
          cd cli && npm install && npm run build && cd ..
          cd server && npm install && npm run build && cd ..
          cd builders && npm install && cd ..
          echo "✓ All packages built successfully"

      - name: Verify package versions
        run: |
          echo "Client version: $(node -p "require('./base/package.json').version")"
          echo "CLI version: $(node -p "require('./cli/package.json').version")"
          echo "Server version: $(node -p "require('./server/package.json').version")"
          echo "Builder version: $(node -p "require('./builders/package.json').version")"

  test-security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Audit client package
        working-directory: ./base
        run: |
          npm install
          npm audit --production || echo "Audit completed with warnings"

      - name: Audit CLI package
        working-directory: ./cli
        run: |
          npm install
          npm audit --production || echo "Audit completed with warnings"

      - name: Audit server package
        working-directory: ./server
        run: |
          npm install
          npm audit --production || echo "Audit completed with warnings"

      - name: Audit builder package
        working-directory: ./builders
        run: |
          npm install
          npm audit --production || echo "Audit completed with warnings"

      - name: Check for known vulnerabilities
        run: |
          echo "Security audit completed for all packages"
